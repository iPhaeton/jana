"use strict";function getData(a,b){if("search"===a)return void searchPanel.submit();var c,d;async.parallel([function(a){makeDBSearchRequest("/dbsearch?db=Config",a)},function(b){makeDBSearchRequest(a,b)}],function(e,f){return storedConfig=c=parseConfig(f[0][0]),storedData=d=f[1],d.url=a,e?void alert("Извините, проблема с базой данных"):void b(d,c)})}function createContent(a,b){var a=a||storedData,b=b||storedConfig;!a&&thumbnails&&thumbnails.clear(),b&&(thumbnails||(thumbnails=new Thumbnails("#commodity-list",a,b)),thumbnails.clear(),thumbnails.build(a,b),thumbnails.render())}function parseConfig(a){for(var b in a.showcase)a.showcase[b].css&&(a.showcase[b].css=new Function("data",a.showcase[b].css));return a}function Thumbnails(a,b){this.elem=$(a),this.tiles=new Set,this.previousWindowWidth=0,this.focusExecuted=!1,this.data=[],this.setHandlers()}function Thumbnail(a,b,c,d){this.parent=a,this.data=b||{img:void 0,specs:{}},this.dataUrl=d,this.details=new Details(this);var e=this;c||(c={showcase:{"Название":{withTitle:!1},"Цена":{withTitle:!1,css:{color:"#c00"}},"В наличии":{withTitle:!0,css:+b.specs["В наличии"].split(" ")[0]?{color:"#0f0"}:{color:"#f00"}}}});var f=$("<div class='col-sm-6 col-md-4 col-lg-3'></div>"),g=$("<div class='thumbnail'></div>");g.css({textAlign:"right"});var h=$("<img src="+(this.data.img||"'images/defaultPic.gif'")+" class='thumbnail-img'>");"edit"===mode&&(h.hover(function(){$(this).css({cursor:"pointer"})}),h.on("click",this.chooseImage.bind(this)));var i=$("<button type='button' class='btn btn-default details-button' data-toggle='modal' data-target='details'>"+("view"===mode?"Подробнее>>":"Редактировать>>")+"</button>");i.on("click",function(a){e.details.render()}),g.append(h);for(var j=gatherItemsInOrder(c.showcase),k=j.length-1;k>=0;k--)if(this.data.specs[j[k]]){var l=$("<p>"+(c.showcase[j[k]].withTitle?j[k]+": "+this.data.specs[j[k]]:this.data.specs[j[k]])+"</p>");c.showcase[j[k]].css&&l.css(c.showcase[j[k]].css(this.data)),g.append(l)}g.append(i),"edit"===mode&&f.on("contextmenu",this.showPopupMenu.bind(this)),f.append(g),this.elem=f}function EditSwitch(a){this.parent=a,this.elem=$("<button type='button' class='btn btn-default'>Редактировать</button>"),this.elem.appendTo($(".main-content")),this.elem.css({float:"right",margin:"5px"}),$(this.elem).on("click",this.switchMode.bind(this))}function EditPanel(){"true"===$(".main-content").attr("admin-mode")&&(this.switch=new EditSwitch(this)),this.elem=$(".edit-panel"),this.elem.on("click",".edit-button",this.buttonClick.bind(this))}function PopupMenu(a,b,c,d){this.parent=a,this.elem=$("<div class='popup-menu'"+(d?"unremovable='true'":"unremovable='false'")+"></div>"),this.list=$("<ul class='list-group'></ul>");for(var e in c)this.addField(e,c[e]?c[e][0]:null,c[e]?c[e][1]:null);this.elem.append(this.list),this.render(b)}var mode="view",thumbnails,storedData,storedConfig,searchPanel,socket=new SockConnection(window.location.origin+"/sock");socket.connect(),$(document).ready(function(){new EditPanel;$(document.body).css({height:$(window).height()}),searchPanel=new SearchPanel({popups:["Производитель"]}),$(".side-menu").on("click",".menu-button",function(a){var b=$(a.target);return(b=findTarget(b,"menu-button","a"))?(sideMenuActive(b),getData(b.attr("href"),createContent),void a.preventDefault()):void a.preventDefault()})}),Thumbnails.prototype.build=function(a,b){if(a){this.data=a,this.config=b;var c=!0,d=!1,e=void 0;try{for(var f,g=this.data[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;this.tiles.add(new Thumbnail(this,h,this.config,this.data.url).elem)}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}}},Thumbnails.prototype.render=function(){this.row=$("<div class='row'></div>");var a=!0,b=!1,c=void 0;try{for(var d,e=this.tiles[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value;this.row.append(f)}}catch(a){b=!0,c=a}finally{try{!a&&e.return&&e.return()}finally{if(b)throw c}}this.elem.append(this.row),this.clearTiles(!0)()},Thumbnails.prototype.add=function(a,b){this.row||(this.row=$("<div class='row'></div>"),this.elem.append(this.row));var c=new Thumbnail(this,a,this.config||storedConfig,"search");this.tiles.add(c.elem),this.row.append(c.elem),this.clearTiles(!0),this.data.push(a),storedData=this.data,b&&this.clearTiles(!0)()},Thumbnails.prototype.clear=function(){this.data=[],this.tiles.clear(),this.row&&this.row.html("")},Thumbnails.prototype.unrender=function(){this.elem.html("")},Thumbnails.prototype.clearTiles=function(a){return function(){var b=$(window).width();b<768?(this.previousWindowWidth>=768||a)&&this.arrangeClears():b>=768&&b<992?(this.previousWindowWidth<768||this.previousWindowWidth>=992||a)&&this.arrangeClears(3):b>=992&&b<1200?(this.previousWindowWidth<992||this.previousWindowWidth>=1200||a)&&this.arrangeClears(4):(this.previousWindowWidth<1200||a)&&this.arrangeClears(5),this.previousWindowWidth=b}.bind(this)},Thumbnails.prototype.arrangeClears=function(a){if(a){a--;var b=0,c=!0,d=!1,e=void 0;try{for(var f,g=this.tiles[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;b%a===0?h.addClass("first-in-a-row"):h.removeClass("first-in-a-row"),b++}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}}else for(var h in this.tiles)h.removeClass("first-in-a-row")},Thumbnails.prototype.setHandlers=function(){$(window).on("resize",this.clearTiles(!1)),$(document).on("focus",function(){this.focusExecuted||(this.focusExecuted=!0,this.clearTiles(!0)(),$(window).off("resize",this.clearTiles(!1)),$(window).on("resize",this.clearTiles(!1)))}.bind(this)),$(document).on("click",function(a){$(a.target).attr("href")&&(this.focusExecuted=!1),$(window).off("resize",this.clearTiles(!1)),$(window).on("resize",this.clearTiles(!1))}.bind(this))},Thumbnail.prototype.chooseImage=function(a){$("#uploadInput").trigger("click",[this.data._id])},Thumbnail.prototype.chooseImageOnServer=function(a){var b=$(a.target);if(b=findTarget(b,"popup-button")){var c=this;makeFileSaveRequest("/savefile?id="+this.data._id,b.text(),function(a){a&&alert(a.message),getData(c.dataUrl,createContent)})}},Thumbnail.prototype.showDirList=function(a){var b=this;makeListRequest("/list?dir=images",function(c,d){c&&alert(c.messge);for(var e={},f=0;f<d.length;f++)e[d[f]]=[b.chooseImageOnServer.bind(b),b.showDirPopupMenu.bind(b)];var g=new PopupMenu(b.elem,a,e,!0);g.elem.addClass("dir-list")})},Thumbnail.prototype.showDirPopupMenu=function(a){$(".popup-menu[unremovable='false']").remove();var b=findTarget($(a.target),"popup-button");if(b){this.selectedImage=b.text();new PopupMenu(this.elem,a,{"Посмотреть":[this.showImage.bind(this)],"Удалить":[this.deleteImage.bind(this)]})}},Thumbnail.prototype.showPopupMenu=function(a){var b=findTarget($(a.target),"thumbnail thumbnail-img details-button popup-menu");if(!b)return void $(".popup-menu").remove();if(b.hasClass("popup-menu")||$(".popup-menu").remove(),b.hasClass("thumbnail")){new PopupMenu(this.elem,a,{"Удалить товар":[this.delete.bind(this)]})}else if(b.hasClass("thumbnail-img")){new PopupMenu(this.elem,a,{"Загрузить новое изображение":[this.chooseImage.bind(this)],"Выбрать изображение на сервере":[this.showDirList.bind(this)]})}else if(b.hasClass("details-button"))return;a.preventDefault()},Thumbnail.prototype.showImage=function(a){$("#image-preview").remove();var b=$(".dir-list");this.iframe=$("<iframe id='image-preview' src='images/"+this.selectedImage+"' scrolling='no'></iframe>"),this.iframe.appendTo(b.parent()),this.iframe.css({position:"absolute",top:b.position().top+"px",left:b.position().left+b.width()+"px",background:"#fff",zIndex:"1"}),this.iframe.on("load",function(){var a=this.iframe.contents().find("img");a.width()>a.height()&&a.width()>this.iframe.width()?$(a).css({width:"100%"}):a.height()>this.iframe.height()&&$(a).css({height:"100%"})}.bind(this))},Thumbnail.prototype.deleteImage=function(a){makeFileDeleteRequest("/delfile?dir=images&file="+this.selectedImage,function(a){a&&alert(a.message),getData(data.url,createContent)})},Thumbnail.prototype.delete=function(a){var b=this;makeDBDelRequest("/dbdel?db=Commodity&id="+this.data._id,function(a){a&&alert(a.message),getData(b.dataUrl,createContent)})},EditSwitch.prototype.switchMode=function(){"edit"!==mode?(mode="edit",this.elem.text("Просмотр"),$("#uploadInput").length||this.createUploadInput()):(mode="view",this.elem.text("Редактировать")),createContent(),this.parent.toggle()},EditSwitch.prototype.createUploadInput=function(){var a=$("<input type='file'>");a.attr("id","uploadInput"),a.css({width:"0",height:"0",border:"0",padding:"0"}),$(document.body).append(a);var b;a.on("click",function(a,c){b=c}),a.on("change",function(a){makeFileSaveRequest("/savefile?id="+b,this.files[0],function(a){a&&alert(a.message),getData(storedData.url,createContent)})})},EditPanel.prototype.buttonClick=function(a){var b=findTarget($(a.target),"edit-button");switch(b.attr("id")){case"add-commodity":return void this.addCommodity();case"add-category":return void this.addCategory()}},EditPanel.prototype.toggle=function(){this.elem.attr("hidden")?this.elem.removeAttr("hidden"):this.elem.attr("hidden","true")},EditPanel.prototype.addCommodity=function(){var a=new Dialog({"Категория":"Лыжи","Название":""},"Commodity");a.render()},EditPanel.prototype.addCategory=function(){var a=new Dialog({"Категория":""},"Category",function(a){var b=a.serializeArray();return{name:b[1].value,url:"/dbsearch?db=Commodity&specs=specs.Категория:"+b[1].value,position:$(".menu-button").length}},function(a,b){return a?void("Документ уже существует"===a.message?alert("Яна, категория с таким имененм у тебя уже есть"):alert(a.message)):void $(".side-menu").append("            <li class='menu-button'>                <a role='presentation' href='"+b.url+"'>"+b.name+"</a>            </li>        ")});a.render()},PopupMenu.prototype.addField=function(a,b,c){var d=$("<li class='btn list-group-item popup-button'>"+a+"</li>");this.list.append(d),d.on("click",function(a){b&&b(a),a.preventDefault(),this.close()}.bind(this)),d.on("contextmenu",function(a){c&&c(a),a.preventDefault()}.bind(this))},PopupMenu.prototype.render=function(a){var b=this.parent.offset();this.parent.append(this.elem),this.elem.css({position:"absolute",left:a?a.clientX-b.left+$(window).scrollLeft()+"px":(window.pageXOffset||document.documentElement.scrollLeft)+document.documentElement.clientWidth/2-this.elem.get(0).offsetWidth/2-b.left+"px",top:a?a.clientY-b.top+$(window).scrollTop()+"px":"10%",zIndex:"1"})},PopupMenu.prototype.close=function(){this.elem.detach()};