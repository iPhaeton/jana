"use strict";function SearchPanel(a){if(this.elem=$(".search-panel"),this.toggleButton=$(".search-button"),this.form=this.elem.find("form"),this.input=this.elem.find("#search-input"),this.setEvents(),this.popups={},a.popups)for(var b=0;b<a.popups.length;b++)this.popups[a.popups[b]]=new SearchPanelPopupControl(a.popups[b],this.elem)}SearchPanel.prototype.setEvents=function(){this.toggleButton.on("click",this.toggle.bind(this)),$(document.documentElement).on("keydown",this,function(a){70===a.keyCode&&a.ctrlKey&&a.shiftKey&&a.data.toggle()}),this.elem.on("click",this.hidePopups.bind(this)),$(".search-panel__hide-button").on("click",this.toggle.bind(this)),this.form.on("submit",this.submit.bind(this))},SearchPanel.prototype.unsetEvents=function(){$(document.documentElement).off("click keydown",this.hide)},SearchPanel.prototype.toggle=function(){var a=this;this.elem.toggleClass("zero-width"),this.elem.hasClass("zero-width")?(this.hidePopups(),this.unsetEvents()):setTimeout(function(){$(document.documentElement).on("click keydown",a,a.hide)},0)},SearchPanel.prototype.hide=function(a){var b=findTarget($(a.target),"search-panel search-panel__popup-panel");if(!b){var c=a.data;a.keyCode&&27!==a.keyCode||(c.toggle(),c.hidePopups(a))}},SearchPanel.prototype.hidePopups=function(a){if(!a||!findTarget($(a.target),"search-panel__control-popup search-panel__popup-panel"))for(var b in this.popups)this.popups[b].hide()},SearchPanel.prototype.submit=function(a){var b=this;a&&a.preventDefault();var c=this.form.serialize();if(this.input.val().length){var d={};for(var e in this.popups)d[e]=this.popups[e].getData();var f;async.parallel([function(a){storedConfig?a():makeDBSearchRequest("/dbsearch?db=Config",a)},function(a){makeSearchRequest(c,d,a,b.showSearchResult)}],function(b,c){a&&this.toggle(),c[0]&&(storedConfig=f=parseConfig(c[0][0])),thumbnails&&(thumbnails.clear(),thumbnails.data.url="search"),socket.send(JSON.stringify({request:"/searchResults"}))}.bind(this))}},SearchPanel.prototype.showSearchResult=function(a,b){thumbnails||(thumbnails=new Thumbnails("#commodity-list",storedData,storedConfig),thumbnails.data.url="search"),thumbnails.add(a,b)},SearchPanelPopupControl=function(a,b){this.elem=$("<div class='search-panel__popup'></div>"),this.name=a,this.parent=b,this.create(),this.render(),Object.defineProperty(this,"data",{get:function(){return this.body.submit(),this._data}})},SearchPanelPopupControl.prototype.create=function(){var a=this;this.button=$('<div class="search-panel__control-popup">            <p class="search-panel__control-popup__text">'+this.name+'</p>            <span class="glyphicon glyphicon-chevron-down search-panel__control-popup__icon" aria-hidden="true"></span>        </div>'),this.body=$("<form class='search-panel__popup-panel zero-display'>            <div class='row'></div>        </form>"),this.getValues(function(b,c){function d(){var b=a.body.find(".row"),c=$("<div class='col'></div>");return b.append(c),c}var e=d(),f=1;for(var g in c)e.append("<label class='checkbox'><input type='checkbox' name='"+g+"'>"+g+"</label>"),f++%20===0&&(e=d());a.bodyWidth=250*Math.ceil(f/20),a.body.css({width:a.bodyWidth+"px"}),$(".col").addClass("col-xs-"+12/Math.ceil(f/20)),$(window).on("resize",a.handleBodySize.bind(a))}),this.elem.append(this.button),$(document.body).append(this.body),this.setEvents()},SearchPanelPopupControl.prototype.getValues=function(a){makeDBSearchRequest("/dbsearch?db=Commodity&field=specs."+this.name,a)},SearchPanelPopupControl.prototype.setEvents=function(){this.button.on("click",this.toggle.bind(this)),this.body.on("click",this.hide.bind(this))},SearchPanelPopupControl.prototype.render=function(){this.parent.append(this.elem)},SearchPanelPopupControl.prototype.toggle=function(){this.body.toggleClass("zero-display"),this.handleBodySize()},SearchPanelPopupControl.prototype.hide=function(a){a&&findTarget($(a.target),"col")||this.body.addClass("zero-display")},SearchPanelPopupControl.prototype.handleBodySize=function(){clearTimeout(this.handleBodySizeTimer);var a=this;this.handleBodySizeTimer=setTimeout(function(){var b=$(window);a.body.css({top:a.button.offset().top+a.button.outerHeight(),right:0}),a.body.position().top+a.body.height()>b.height()?a.body.css({position:"absolute"}):a.body.css({position:"fixed"}),b.width()>a.bodyWidth?a.body.css({width:a.bodyWidth+"px"}):a.body.css({width:b.width()+"px"})},100)},SearchPanelPopupControl.prototype.getData=function(){return this._data=this.body.serializeArray(),this._data};