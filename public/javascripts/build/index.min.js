"use strict";function findTarget(a,b,c){b=b.split(" ");do{for(var d=0;d<b.length;d++)if(a.hasClass(b[d])||a.attr("id")===b[d])return c?a.children(c):a;a=a.parent()}while(a.length)}function gatherItemsInOrder(a){var b=[];for(var c in a)b.push(c);return b}function Details(a){a.data&&(ModalWindow.call(this,!1),this.parent=a,this.elem.attr("id","details"),this.elem.css({background:"#079",padding:"0px"}))}function Dialog(a,b,c,d){var e={data:{_id:null,specs:a}};Details.call(this,e),this.db=b,this.createData=c,this.callback=d}function AuthWindow(a){ModalWindow.call(this,!0),this.elem.attr("id","authentification"),this.elem.css({background:"#fff",padding:"5px",border:"1px solid #ccc",borderRadius:"5px"}),this.type=a}function ModalWindow(){this.elem=$("<div class='mod'></div>"),this.elem.css({zIndex:3}),this.focusExecuted=!1}function makeDBSearchRequest(a,b){$.ajax({url:a,type:"GET",dataType:"json"}).done(function(a){b(null,a)}).fail(function(a,c,d){b(d)})}function makeDBSaveRequest(a,b,c){$.ajax({url:a,type:"POST",data:b,statusCode:{200:function(){c(null)},403:function(a){c(JSON.parse(a.responseText))}}})}function makeDBDelRequest(a,b){$.ajax({url:a,type:"POST",statusCode:{200:function(){b(null)},404:function(a){b(JSON.parse(a.responseText))}}})}function makeFileSaveRequest(a,b,c){$.ajax({url:a,type:"POST",data:b,headers:{"x-file-name":b.name||b},processData:!1,contentType:!1,statusCode:{200:function(){c(null)},403:function(a){c(JSON.parse(a.responseText))}}})}function makeFileDeleteRequest(a,b){$.ajax({url:a,type:"GET"}).done(function(){b()}).fail(function(a,c,d){b(d)})}function makeListRequest(a,b){$.ajax({url:a,type:"GET",dataType:"json"}).done(function(a){b(null,a)}).fail(function(a,c,d){b(d)})}function makeAuthorizationRequest(a,b,c){$.ajax({url:a,type:"POST",data:b?b.serialize():null}).done(function(a){c(null,a)}).fail(function(a,b,d){c(JSON.parse(a.responseText))})}Details.prototype=Object.create(ModalWindow.prototype),Details.prototype.constructor=Details,Details.prototype.render=function(){if(!this.elem.html()&&(this.content=$("<form></form>"),this.createContent(),"edit"===mode)){var a=$("<button type='submit' class='btn btn-default' id='save-button'>Сохранить</button>");a.css({float:"right"});var b=$("<button type='button' class='btn btn-default' id='add-button'>Добавить</button>"),c=$("<button type='button' class='btn btn-default' id='cancel-button'>Отмена</button>");c.css({float:"right"}),this.content.append(c),this.content.append(b),this.content.append(a)}this.content.on("submit",this.submit.bind(this)),this.content.on("click",".btn",this.editButtonClick.bind(this)),this._render(this.content)},Details.prototype.createContent=function(){this.elem.find("#details__content").remove();var a=$("<div class='panel panel-default' id='details__content'></div>");this.table=$("<table class='table'><tbody></tbody></table>");for(var b=gatherItemsInOrder(this.parent.data.specs),c=b.length-1;c>=0;c--)this.addField(this.table.find("tbody"),{key:b[c],val:this.parent.data.specs[b[c]]});a.append(this.table),this.content.prepend(a)},Details.prototype.editButtonClick=function(a){var b=$(a.target);if(b=findTarget(b,"btn")){switch(b.attr("id")){case"add-button":this.addField(this.table.find("tbody"));break;case"rm-button":this.removeField(this.table.find("tbody"),b.attr("num"));break;case"cancel-button":this.createContent(),this.close()}b.blur()}},Details.prototype.addField=function(a,b){"edit"===mode?a.append("<tr>                <td><input name='key' value='"+(b?b.key:"")+"'></td>                <td><input name='val' value='"+(b?b.val:"")+"'></td>                <td><input type='button' class='btn' id='rm-button' num='"+a.children().length+"' value='Удалить'></td>            </tr>"):a.append("<tr>                <td>"+(b?b.key:"")+"</td>                <td>"+(b?b.val:"")+"</td>            </tr>")},Details.prototype.removeField=function(a,b){a.children().eq(+b).remove();for(var c=+b;c<a.children().length;c++)a.children().eq(c).find("input").attr("num",c)},Details.prototype.submit=function(a){var b=$(a.target),c=this;makeDBSaveRequest("/dbsave?db=Commodity&id="+this.parent.data._id,b.serializeArray(),function(a){a&&alert(a.message),getData(c.parent.dataUrl,createContent)}),this.close(),a.preventDefault()},Dialog.prototype=Object.create(Details.prototype),Dialog.prototype.constructor=Dialog,Dialog.prototype.submit=function(a){var b=this,c=$(a.target);if(this.createData)var d=this.createData(c);else var d=c.serializeArray();!d.url&&storedData&&(d.url=storedData.url),makeDBSaveRequest("/dbsave?db="+this.db+"&id="+this.parent.data._id,d,function(a){return a?void(b.callback?b.callback(a):alert(a.message)):void(d&&getData(d.url,function(){createContent(),b.callback&&b.callback(null,d),"Category"===b.db&&sideMenuActive($(".side-menu a[href='"+d.url+"']"))}))}),this.close(),a.preventDefault()},AuthWindow.prototype=Object.create(ModalWindow.prototype),AuthWindow.prototype.constructor=AuthWindow,AuthWindow.prototype.render=function(){this.form=$("<form>        <div class='form-group'>            <label for='username' class='sr-only'>Имя пользователя</label>                <input type='text' class='form-control' name='username' id='username' placeholder='Имя пользователя'>        </div>        <div class='form-group'>            <label for='password' class='sr-only'>Пароль</label>                <input type='password' class='form-control' name='password' id='password' placeholder='Пароль' autocomplete='off'>        </div>    </form>"),this.form.css({minWidth:300});var a=$("<button type='submit' class='btn btn-primary' id='auth-button'>"+("signin"===this.type?"Войти":"signup"===this.type?"Регистрация":"")+"</button>");a.css({margin:"0 10px 10px 10px",float:"right"}),this.form.append(a),this.form.on("submit",this.submit.bind(this)),this._render(this.form)},AuthWindow.prototype.submit=function(a){makeAuthorizationRequest("/"+this.type,this.form,function(a){a?alert(a.message):(ModalWindow.prototype.close(),location.reload())}),a.preventDefault()},ModalWindow.prototype._render=function(a){if(this.close(),this.preventScrolling(!0),!this.elem.html()){a&&this.elem.append(a),this.closeButton=$("<div></div>"),this.closeButton.css({width:"20px",height:"20px",float:"right"});var b=$("<img src='/images/gtk-close.png'>");b.css({width:"100%",height:"100%"}),this.closeButton.append(b),this.closeButton.hover(function(){$(this).css({cursor:"pointer"})});var c=$("<div class='clearfix'></div>");this.elem.prepend(this.closeButton),c.insertAfter(this.closeButton),this.elem.css({position:"fixed"})}this.elem.css({visibility:"hidden"}),$(document.body).append(this.elem),this.closeButton.on("click",this.close.bind(this)),$(window).on("resize",this.position.bind(this)),$(document).on("focus",function(){this.focusExecuted||(this.focusExecuted=!0,$(window).off("resize",this.position.bind(this)),$(window).on("resize",this.position.bind(this)))}.bind(this)),$(document).on("click",function(a){$(a.target).attr("href")&&(this.focusExecuted=!1),$(window).off("resize",this.position.bind(this)),$(window).on("resize",this.position.bind(this))}.bind(this)),this.position()},ModalWindow.prototype.position=function(){var a=this;setTimeout(function(){var b=$(window);a.elem.width()>b.width()?a.elem.css({position:"absolute",top:b.scrollTop()+30+"px",left:"0px"}):a.elem.height()+30>b.height()?a.elem.css({position:"absolute",top:b.scrollTop()+"px",left:b.scrollLeft()+b.width()/2-a.elem.width()/2+"px"}):a.elem.css({position:"fixed",top:"30px",left:b.scrollLeft()+b.width()/2-a.elem.width()/2+"px"}),a.elem.css({visibility:"visible"})},0)},ModalWindow.prototype.close=function(){$(".mod").remove(),this.preventScrolling(!1)},ModalWindow.prototype.preventScrolling=function(a){var b=$(document);if($(document.body).css({overflow:a?"hidden":"visible"}),a){var c=$("<div class='dim-background'></div>");c.css({position:"absolute",top:0,left:0,width:"100%",height:b.height(),background:"rgba(0,0,0,.5)",zIndex:2}),$(document.body).append(c)}else $(".dim-background").remove()},function(a){function b(a){var b=new AuthWindow(a);b.render()}$(document).ready(function(){$("#signin, #signup").on("click",function(a){a.preventDefault();var c=findTarget($(a.target),"signin signup");c&&b(c.attr("id"))}),$("#signout").on("click",function(a){a.preventDefault();var b=findTarget($(a.target),"signout");b&&makeAuthorizationRequest("/signout",null,function(a){a?alert(a.message):window.location.href="/"})}),$(document.documentElement).on("click keydown",function(a){a.keyCode&&27!==a.keyCode||findTarget($(a.target),"mod")||(findTarget($(a.target),"popup-button")&&27!==a.keyCode||($("#image-preview").remove(),$(".popup-menu").detach()),findTarget($(a.target),"details-button edit-button rm-button signin signup")&&27!==a.keyCode||ModalWindow.prototype.close())})})}();