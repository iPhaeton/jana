"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function Details(a){a.data&&(ModalWindow.call(this,!1),this.parent=a,this.elem.attr("id","details"),this.elem.css({background:"#079",padding:"0px"}))}function Dialog(a,b,c,d){var e={data:{_id:null,specs:a}};Details.call(this,e),this.db=b,this.createData=c,this.callback=d}function AuthWindow(a){ModalWindow.call(this,!0),this.elem.attr("id","authentification"),this.elem.css({background:"#fff",padding:"5px",border:"1px solid #ccc",borderRadius:"5px"}),this.type=a}function ModalWindow(){this.elem=$("<div class='mod'></div>"),this.elem.css({zIndex:3}),this.focusExecuted=!1}function findTarget(a,b,c){b=b.split(" ");do{for(var d=0;d<b.length;d++)if(a.hasClass(b[d])||a.attr("id")===b[d])return c?a.children(c):a;a=a.parent()}while(a.length)}function gatherItemsInOrder(a){var b=[];for(var c in a)b.push(c);return b}function makeDBSearchRequest(a,b){$.ajax({url:a,type:"GET",dataType:"json"}).done(function(a){b(null,a)}).fail(function(a,c,d){b(d)})}function makeDBSaveRequest(a,b,c){$.ajax({url:a,type:"POST",data:b,statusCode:{200:function(){c(null)},403:function(a){c(JSON.parse(a.responseText))}}})}function makeDBDelRequest(a,b){$.ajax({url:a,type:"POST",statusCode:{200:function(){b(null)},404:function(a){b(JSON.parse(a.responseText))}}})}function makeFileSaveRequest(a,b,c){$.ajax({url:a,type:"POST",data:b,headers:{"x-file-name":b.name||b},processData:!1,contentType:!1,statusCode:{200:function(){c(null)},403:function(a){c(JSON.parse(a.responseText))}}})}function makeFileDeleteRequest(a,b){$.ajax({url:a,type:"GET"}).done(function(){b()}).fail(function(a,c,d){b(d)})}function makeListRequest(a,b){$.ajax({url:a,type:"GET",dataType:"json"}).done(function(a){b(null,a)}).fail(function(a,c,d){b(d)})}function makeAuthorizationRequest(a,b,c){$.ajax({url:a,type:"POST",data:b?b.serialize():null}).done(function(a){c(null,a)}).fail(function(a,b,d){c(JSON.parse(a.responseText))})}function makeSearchRequest(a,b,c,d){var e=Math.random();socket.callbacks.searchResult=function(a,b,f,g){return"searchComplete"===b?void c(null,null):a?(alert("Ошибка поиска. Выведены не все результаты."),void(socket.callbacks.searchResult=null)):b?void(g===e&&d(b,f)):void alert("Ничего не найдено")},socket.send(JSON.stringify({request:"/search?"+a,data:b,key:e}))}function sideMenuActive(a){$(".side-menu > .menu-button").removeClass("active"),a.parent().addClass("active"),a.blur()}function getData(a,b){if("search"===a)return void searchPanel.submit();var c,d;async.parallel([function(a){makeDBSearchRequest("/dbsearch?db=Config",a)},function(b){makeDBSearchRequest(a,b)}],function(e,f){return storedConfig=c=parseConfig(f[0][0]),storedData=d=f[1],d.url=a,e?void alert("Извините, проблема с базой данных"):void b(d,c)})}function createContent(a,b){var a=a||storedData,b=b||storedConfig;!a&&thumbnails&&thumbnails.clear(),b&&(thumbnails||(thumbnails=new Thumbnails("#commodity-list",a,b)),thumbnails.clear(),thumbnails.build(a,b),thumbnails.render())}function parseConfig(a){for(var b in a.showcase)a.showcase[b].css&&(a.showcase[b].css=new Function("data",a.showcase[b].css));return a}function Thumbnails(a,b){this.elem=$(a),this.tiles=new Set,this.previousWindowWidth=0,this.focusExecuted=!1,this.data=[],this.setHandlers()}function Thumbnail(a,b,c,d){this.parent=a,this.data=b||{img:void 0,specs:{}},this.dataUrl=d,this.details=new Details(this);var e=this;c||(c={showcase:{"Название":{withTitle:!1},"Цена":{withTitle:!1,css:{color:"#c00"}},"В наличии":{withTitle:!0,css:+b.specs["В наличии"].split(" ")[0]?{color:"#0f0"}:{color:"#f00"}}}});var f=$("<div class='col-sm-6 col-md-4 col-lg-3'></div>"),g=$("<div class='thumbnail'></div>");g.css({textAlign:"right"});var h=$("<img src="+(this.data.img||"'images/defaultPic.gif'")+" class='thumbnail-img'>");"edit"===mode&&(h.hover(function(){$(this).css({cursor:"pointer"})}),h.on("click",this.chooseImage.bind(this)));var i=$("<button type='button' class='btn btn-default details-button' data-toggle='modal' data-target='details'>"+("view"===mode?"Подробнее>>":"Редактировать>>")+"</button>");i.on("click",function(a){e.details.render()}),g.append(h);for(var j=gatherItemsInOrder(c.showcase),k=j.length-1;k>=0;k--)if(this.data.specs[j[k]]){var l=$("<p>"+(c.showcase[j[k]].withTitle?j[k]+": "+this.data.specs[j[k]]:this.data.specs[j[k]])+"</p>");c.showcase[j[k]].css&&l.css(c.showcase[j[k]].css(this.data)),g.append(l)}g.append(i),"edit"===mode&&f.on("contextmenu",this.showPopupMenu.bind(this)),f.append(g),this.elem=f}function EditSwitch(a){this.parent=a,this.elem=$("<button type='button' class='btn btn-default'>Редактировать</button>"),this.elem.appendTo($(".main-content")),this.elem.css({float:"right",margin:"5px"}),$(this.elem).on("click",this.switchMode.bind(this))}function EditPanel(){"true"===$(".main-content").attr("admin-mode")&&(this.switch=new EditSwitch(this)),this.elem=$(".edit-panel"),this.elem.on("click",".edit-button",this.buttonClick.bind(this))}function PopupMenu(a,b,c,d){this.parent=a,this.elem=$("<div class='popup-menu'"+(d?"unremovable='true'":"unremovable='false'")+"></div>"),this.list=$("<ul class='list-group'></ul>");for(var e in c)this.addField(e,c[e]?c[e][0]:null,c[e]?c[e][1]:null);this.elem.append(this.list),this.render(b)}function SearchPanel(a){if(this.elem=$(".search-panel"),this.toggleButton=$(".search-button"),this.form=this.elem.find("form"),this.input=this.elem.find("#search-input"),this.setEvents(),this.popups={},a.popups)for(var b=0;b<a.popups.length;b++)this.popups[a.popups[b]]=new SearchPanelPopupControl(a.popups[b],this.elem)}function SearchPanelPopupControl(a,b){this.elem=$("<div class='search-panel__popup'></div>"),this.name=a,this.parent=b,this.create(),this.render(),Object.defineProperty(this,"data",{get:function(){return this.body.submit(),this._data}})}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),SockConnection=function(){function a(b){_classCallCheck(this,a),this.url=b,this.callbacks={searchResult:null}}return _createClass(a,[{key:"connect",value:function(){this.connection=new SockJS(this.url);var a=this;this.connection.onopen=function(){},this.connection.onmessage=function(b){var c=JSON.parse(b.data),d=c.data,e=c.type,f=c.done,g=c.key;a.callbacks[e]&&("Error"===d?a.callbacks[e](new Error(e+" error")):a.callbacks[e](null,d,f,g))}}},{key:"send",value:function(a){this.lastRequest=a,this.connection.send(a)}},{key:"setHandlers",value:function(){}}]),a}();Details.prototype=Object.create(ModalWindow.prototype),Details.prototype.constructor=Details,Details.prototype.render=function(){if(!this.elem.html()&&(this.content=$("<form></form>"),this.createContent(),"edit"===mode)){var a=$("<button type='submit' class='btn btn-default' id='save-button'>Сохранить</button>");a.css({float:"right"});var b=$("<button type='button' class='btn btn-default' id='add-button'>Добавить</button>"),c=$("<button type='button' class='btn btn-default' id='cancel-button'>Отмена</button>");c.css({float:"right"}),this.content.append(c),this.content.append(b),this.content.append(a)}this.content.on("submit",this.submit.bind(this)),this.content.on("click",".btn",this.editButtonClick.bind(this)),this._render(this.content)},Details.prototype.createContent=function(){this.elem.find("#details__content").remove();var a=$("<div class='panel panel-default' id='details__content'></div>");this.table=$("<table class='table'><tbody></tbody></table>");for(var b=gatherItemsInOrder(this.parent.data.specs),c=b.length-1;c>=0;c--)this.addField(this.table.find("tbody"),{key:b[c],val:this.parent.data.specs[b[c]]});a.append(this.table),this.content.prepend(a)},Details.prototype.editButtonClick=function(a){var b=$(a.target);if(b=findTarget(b,"btn")){switch(b.attr("id")){case"add-button":this.addField(this.table.find("tbody"));break;case"rm-button":this.removeField(this.table.find("tbody"),b.attr("num"));break;case"cancel-button":this.createContent(),this.close()}b.blur()}},Details.prototype.addField=function(a,b){"edit"===mode?a.append("<tr>                <td><input name='key' value='"+(b?b.key:"")+"'></td>                <td><input name='val' value='"+(b?b.val:"")+"'></td>                <td><input type='button' class='btn' id='rm-button' num='"+a.children().length+"' value='Удалить'></td>            </tr>"):a.append("<tr>                <td>"+(b?b.key:"")+"</td>                <td>"+(b?b.val:"")+"</td>            </tr>")},Details.prototype.removeField=function(a,b){a.children().eq(+b).remove();for(var c=+b;c<a.children().length;c++)a.children().eq(c).find("input").attr("num",c)},Details.prototype.submit=function(a){var b=$(a.target),c=this;makeDBSaveRequest("/dbsave?db=Commodity&id="+this.parent.data._id,b.serializeArray(),function(a){a&&alert(a.message),getData(c.parent.dataUrl,createContent)}),this.close(),a.preventDefault()},Dialog.prototype=Object.create(Details.prototype),Dialog.prototype.constructor=Dialog,Dialog.prototype.submit=function(a){var b=this,c=$(a.target);if(this.createData)var d=this.createData(c);else var d=c.serializeArray();!d.url&&storedData&&(d.url=storedData.url),makeDBSaveRequest("/dbsave?db="+this.db+"&id="+this.parent.data._id,d,function(a){return a?void(b.callback?b.callback(a):alert(a.message)):void(d&&getData(d.url,function(){createContent(),b.callback&&b.callback(null,d),"Category"===b.db&&sideMenuActive($(".side-menu a[href='"+d.url+"']"))}))}),this.close(),a.preventDefault()},AuthWindow.prototype=Object.create(ModalWindow.prototype),AuthWindow.prototype.constructor=AuthWindow,AuthWindow.prototype.render=function(){this.form=$("<form>        <div class='form-group'>            <label for='username' class='sr-only'>Имя пользователя</label>                <input type='text' class='form-control' name='username' id='username' placeholder='Имя пользователя'>        </div>        <div class='form-group'>            <label for='password' class='sr-only'>Пароль</label>                <input type='password' class='form-control' name='password' id='password' placeholder='Пароль' autocomplete='off'>        </div>    </form>"),this.form.css({minWidth:300});var a=$("<button type='submit' class='btn btn-primary' id='auth-button'>"+("signin"===this.type?"Войти":"signup"===this.type?"Регистрация":"")+"</button>");a.css({margin:"0 10px 10px 10px",float:"right"}),this.form.append(a),this.form.on("submit",this.submit.bind(this)),this._render(this.form)},AuthWindow.prototype.submit=function(a){makeAuthorizationRequest("/"+this.type,this.form,function(a){a?alert(a.message):(ModalWindow.prototype.close(),location.reload())}),a.preventDefault()},ModalWindow.prototype._render=function(a){if(this.close(),this.preventScrolling(!0),!this.elem.html()){a&&this.elem.append(a),this.closeButton=$("<div></div>"),this.closeButton.css({width:"20px",height:"20px",float:"right"});var b=$("<img src='/images/gtk-close.png'>");b.css({width:"100%",height:"100%"}),this.closeButton.append(b),this.closeButton.hover(function(){$(this).css({cursor:"pointer"})});var c=$("<div class='clearfix'></div>");this.elem.prepend(this.closeButton),c.insertAfter(this.closeButton),this.elem.css({position:"fixed"})}this.elem.css({visibility:"hidden"}),$(document.body).append(this.elem),this.closeButton.on("click",this.close.bind(this)),$(window).on("resize",this.position.bind(this)),$(document).on("focus",function(){this.focusExecuted||(this.focusExecuted=!0,$(window).off("resize",this.position.bind(this)),$(window).on("resize",this.position.bind(this)))}.bind(this)),$(document).on("click",function(a){$(a.target).attr("href")&&(this.focusExecuted=!1),$(window).off("resize",this.position.bind(this)),$(window).on("resize",this.position.bind(this))}.bind(this)),this.position()},ModalWindow.prototype.position=function(){var a=this;setTimeout(function(){var b=$(window);a.elem.width()>b.width()?a.elem.css({position:"absolute",top:b.scrollTop()+30+"px",left:"0px"}):a.elem.height()+30>b.height()?a.elem.css({position:"absolute",top:b.scrollTop()+"px",left:b.scrollLeft()+b.width()/2-a.elem.width()/2+"px"}):a.elem.css({position:"fixed",top:"30px",left:b.scrollLeft()+b.width()/2-a.elem.width()/2+"px"}),a.elem.css({visibility:"visible"})},0)},ModalWindow.prototype.close=function(){$(".mod").remove(),this.preventScrolling(!1)},ModalWindow.prototype.preventScrolling=function(a){var b=$(document);if($(document.body).css({overflow:a?"hidden":"visible"}),a){var c=$("<div class='dim-background'></div>");c.css({position:"absolute",top:0,left:0,width:"100%",height:b.height(),background:"rgba(0,0,0,.5)",zIndex:2}),$(document.body).append(c)}else $(".dim-background").remove()},function(a){function b(a){var b=new AuthWindow(a);b.render()}$(document).ready(function(){$("#signin, #signup").on("click",function(a){a.preventDefault();var c=findTarget($(a.target),"signin signup");c&&b(c.attr("id"))}),$("#signout").on("click",function(a){a.preventDefault();var b=findTarget($(a.target),"signout");b&&makeAuthorizationRequest("/signout",null,function(a){a?alert(a.message):window.location.href="/"})}),$(document.documentElement).on("click keydown",function(a){a.keyCode&&27!==a.keyCode||findTarget($(a.target),"mod")||(findTarget($(a.target),"popup-button")&&27!==a.keyCode||($("#image-preview").remove(),$(".popup-menu").detach()),findTarget($(a.target),"details-button edit-button rm-button signin signup")&&27!==a.keyCode||ModalWindow.prototype.close())})})}(),function(){function a(a){if(!findTarget($(a.target),"popup-menu")&&($(".popup-menu").remove(),"edit"===mode)){new PopupMenu($(this),a,{"Удалить категорию":[b.bind($(this))]});a.preventDefault()}}function b(){var a=this;makeDBDelRequest("/dbdel?db=Category&name="+this.find("a").text(),function(b){return b?void alert(b.message):void a.remove()})}$(document).ready(function(){$(".side-menu").on("contextmenu",".menu-button",a)})}();var mode="view",thumbnails,storedData,storedConfig,searchPanel,socket=new SockConnection(window.location.origin+"/sock");socket.connect(),$(document).ready(function(){new EditPanel;$(document.body).css({height:$(window).height()}),searchPanel=new SearchPanel({popups:["Производитель"]}),$(".side-menu").on("click",".menu-button",function(a){var b=$(a.target);return(b=findTarget(b,"menu-button","a"))?(sideMenuActive(b),getData(b.attr("href"),createContent),void a.preventDefault()):void a.preventDefault()})}),Thumbnails.prototype.build=function(a,b){if(a){this.data=a,this.config=b;var c=!0,d=!1,e=void 0;try{for(var f,g=this.data[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;this.tiles.add(new Thumbnail(this,h,this.config,this.data.url).elem)}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}}},Thumbnails.prototype.render=function(){this.row=$("<div class='row'></div>");var a=!0,b=!1,c=void 0;try{for(var d,e=this.tiles[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value;this.row.append(f)}}catch(a){b=!0,c=a}finally{try{!a&&e.return&&e.return()}finally{if(b)throw c}}this.elem.append(this.row),this.clearTiles(!0)()},Thumbnails.prototype.add=function(a,b){this.row||(this.row=$("<div class='row'></div>"),this.elem.append(this.row));var c=new Thumbnail(this,a,this.config||storedConfig,"search");this.tiles.add(c.elem),this.row.append(c.elem),this.clearTiles(!0),this.data.push(a),storedData=this.data,b&&this.clearTiles(!0)()},Thumbnails.prototype.clear=function(){this.data=[],this.tiles.clear(),this.row&&this.row.html("")},Thumbnails.prototype.unrender=function(){this.elem.html("")},Thumbnails.prototype.clearTiles=function(a){return function(){var b=$(window).width();b<768?(this.previousWindowWidth>=768||a)&&this.arrangeClears():b>=768&&b<992?(this.previousWindowWidth<768||this.previousWindowWidth>=992||a)&&this.arrangeClears(3):b>=992&&b<1200?(this.previousWindowWidth<992||this.previousWindowWidth>=1200||a)&&this.arrangeClears(4):(this.previousWindowWidth<1200||a)&&this.arrangeClears(5),this.previousWindowWidth=b}.bind(this)},Thumbnails.prototype.arrangeClears=function(a){if(a){a--;var b=0,c=!0,d=!1,e=void 0;try{for(var f,g=this.tiles[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;b%a===0?h.addClass("first-in-a-row"):h.removeClass("first-in-a-row"),b++}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}}else for(var h in this.tiles)h.removeClass("first-in-a-row")},Thumbnails.prototype.setHandlers=function(){$(window).on("resize",this.clearTiles(!1)),$(document).on("focus",function(){this.focusExecuted||(this.focusExecuted=!0,this.clearTiles(!0)(),$(window).off("resize",this.clearTiles(!1)),$(window).on("resize",this.clearTiles(!1)))}.bind(this)),$(document).on("click",function(a){$(a.target).attr("href")&&(this.focusExecuted=!1),$(window).off("resize",this.clearTiles(!1)),$(window).on("resize",this.clearTiles(!1))}.bind(this))},Thumbnail.prototype.chooseImage=function(a){$("#uploadInput").trigger("click",[this.data._id])},Thumbnail.prototype.chooseImageOnServer=function(a){var b=$(a.target);if(b=findTarget(b,"popup-button")){var c=this;makeFileSaveRequest("/savefile?id="+this.data._id,b.text(),function(a){a&&alert(a.message),getData(c.dataUrl,createContent)})}},Thumbnail.prototype.showDirList=function(a){var b=this;makeListRequest("/list?dir=images",function(c,d){c&&alert(c.messge);for(var e={},f=0;f<d.length;f++)e[d[f]]=[b.chooseImageOnServer.bind(b),b.showDirPopupMenu.bind(b)];var g=new PopupMenu(b.elem,a,e,!0);g.elem.addClass("dir-list")})},Thumbnail.prototype.showDirPopupMenu=function(a){$(".popup-menu[unremovable='false']").remove();var b=findTarget($(a.target),"popup-button");if(b){this.selectedImage=b.text();new PopupMenu(this.elem,a,{"Посмотреть":[this.showImage.bind(this)],"Удалить":[this.deleteImage.bind(this)]})}},Thumbnail.prototype.showPopupMenu=function(a){var b=findTarget($(a.target),"thumbnail thumbnail-img details-button popup-menu");if(!b)return void $(".popup-menu").remove();if(b.hasClass("popup-menu")||$(".popup-menu").remove(),b.hasClass("thumbnail")){new PopupMenu(this.elem,a,{"Удалить товар":[this.delete.bind(this)]})}else if(b.hasClass("thumbnail-img")){new PopupMenu(this.elem,a,{"Загрузить новое изображение":[this.chooseImage.bind(this)],"Выбрать изображение на сервере":[this.showDirList.bind(this)]})}else if(b.hasClass("details-button"))return;a.preventDefault()},Thumbnail.prototype.showImage=function(a){$("#image-preview").remove();var b=$(".dir-list");this.iframe=$("<iframe id='image-preview' src='images/"+this.selectedImage+"' scrolling='no'></iframe>"),this.iframe.appendTo(b.parent()),this.iframe.css({position:"absolute",top:b.position().top+"px",left:b.position().left+b.width()+"px",background:"#fff",zIndex:"1"}),this.iframe.on("load",function(){var a=this.iframe.contents().find("img");a.width()>a.height()&&a.width()>this.iframe.width()?$(a).css({width:"100%"}):a.height()>this.iframe.height()&&$(a).css({height:"100%"})}.bind(this))},Thumbnail.prototype.deleteImage=function(a){makeFileDeleteRequest("/delfile?dir=images&file="+this.selectedImage,function(a){a&&alert(a.message),getData(data.url,createContent)})},Thumbnail.prototype.delete=function(a){var b=this;makeDBDelRequest("/dbdel?db=Commodity&id="+this.data._id,function(a){a&&alert(a.message),getData(b.dataUrl,createContent)})},EditSwitch.prototype.switchMode=function(){"edit"!==mode?(mode="edit",this.elem.text("Просмотр"),$("#uploadInput").length||this.createUploadInput()):(mode="view",this.elem.text("Редактировать")),createContent(),this.parent.toggle()},EditSwitch.prototype.createUploadInput=function(){var a=$("<input type='file'>");a.attr("id","uploadInput"),a.css({width:"0",height:"0",border:"0",padding:"0"}),$(document.body).append(a);var b;a.on("click",function(a,c){b=c}),a.on("change",function(a){makeFileSaveRequest("/savefile?id="+b,this.files[0],function(a){a&&alert(a.message),getData(storedData.url,createContent)})})},EditPanel.prototype.buttonClick=function(a){var b=findTarget($(a.target),"edit-button");switch(b.attr("id")){case"add-commodity":return void this.addCommodity();case"add-category":return void this.addCategory()}},EditPanel.prototype.toggle=function(){this.elem.attr("hidden")?this.elem.removeAttr("hidden"):this.elem.attr("hidden","true")},EditPanel.prototype.addCommodity=function(){var a=new Dialog({"Категория":"Лыжи","Название":""},"Commodity");a.render()},EditPanel.prototype.addCategory=function(){var a=new Dialog({"Категория":""},"Category",function(a){var b=a.serializeArray();return{name:b[1].value,url:"/dbsearch?db=Commodity&specs=specs.Категория:"+b[1].value,position:$(".menu-button").length}},function(a,b){return a?void("Документ уже существует"===a.message?alert("Яна, категория с таким имененм у тебя уже есть"):alert(a.message)):void $(".side-menu").append("            <li class='menu-button'>                <a role='presentation' href='"+b.url+"'>"+b.name+"</a>            </li>        ")});a.render()},PopupMenu.prototype.addField=function(a,b,c){var d=$("<li class='btn list-group-item popup-button'>"+a+"</li>");this.list.append(d),d.on("click",function(a){b&&b(a),a.preventDefault(),this.close()}.bind(this)),d.on("contextmenu",function(a){c&&c(a),a.preventDefault()}.bind(this))},PopupMenu.prototype.render=function(a){var b=this.parent.offset();this.parent.append(this.elem),this.elem.css({position:"absolute",left:a?a.clientX-b.left+$(window).scrollLeft()+"px":(window.pageXOffset||document.documentElement.scrollLeft)+document.documentElement.clientWidth/2-this.elem.get(0).offsetWidth/2-b.left+"px",top:a?a.clientY-b.top+$(window).scrollTop()+"px":"10%",zIndex:"1"})},PopupMenu.prototype.close=function(){this.elem.detach()},SearchPanel.prototype.setEvents=function(){this.toggleButton.on("click",this.toggle.bind(this)),$(document.documentElement).on("keydown",this,function(a){70===a.keyCode&&a.ctrlKey&&a.shiftKey&&a.data.toggle()}),this.elem.on("click",this.hidePopups.bind(this)),$(".search-panel__hide-button").on("click",this.toggle.bind(this)),this.form.on("submit",this.submit.bind(this))},SearchPanel.prototype.unsetEvents=function(){$(document.documentElement).off("click keydown",this.hide)},SearchPanel.prototype.toggle=function(){var a=this;this.elem.toggleClass("zero-width"),this.elem.hasClass("zero-width")?(this.hidePopups(),this.unsetEvents()):setTimeout(function(){$(document.documentElement).on("click keydown",a,a.hide)},0)},SearchPanel.prototype.hide=function(a){var b=findTarget($(a.target),"search-panel search-panel__popup-panel");if(!b){var c=a.data;a.keyCode&&27!==a.keyCode||(c.toggle(),c.hidePopups(a))}},SearchPanel.prototype.hidePopups=function(a){if(!a||!findTarget($(a.target),"search-panel__control-popup search-panel__popup-panel"))for(var b in this.popups)this.popups[b].hide()},SearchPanel.prototype.submit=function(a){var b=this;a&&a.preventDefault();var c=this.form.serialize();if(this.input.val().length){var d={};for(var e in this.popups)d[e]=this.popups[e].getData();var f;async.parallel([function(a){storedConfig?a():makeDBSearchRequest("/dbsearch?db=Config",a)},function(a){makeSearchRequest(c,d,a,b.showSearchResult)}],function(b,c){a&&this.toggle(),c[0]&&(storedConfig=f=parseConfig(c[0][0])),thumbnails&&(thumbnails.clear(),thumbnails.data.url="search"),socket.send(JSON.stringify({request:"/searchResults"}))}.bind(this))}},SearchPanel.prototype.showSearchResult=function(a,b){thumbnails||(thumbnails=new Thumbnails("#commodity-list",storedData,storedConfig),thumbnails.data.url="search"),thumbnails.add(a,b)},SearchPanelPopupControl.prototype.create=function(){var a=this;this.button=$('<div class="search-panel__control-popup">            <p class="search-panel__control-popup__text">'+this.name+'</p>            <span class="glyphicon glyphicon-chevron-down search-panel__control-popup__icon" aria-hidden="true"></span>        </div>'),this.body=$("<form class='search-panel__popup-panel zero-display'>            <div class='row'></div>        </form>"),this.getValues(function(b,c){function d(){var b=a.body.find(".row"),c=$("<div class='col'></div>");return b.append(c),c}var e=d(),f=1;for(var g in c)e.append("<label class='checkbox'><input type='checkbox' name='"+g+"'>"+g+"</label>"),f++%20===0&&(e=d());a.bodyWidth=250*Math.ceil(f/20),a.body.css({width:a.bodyWidth+"px"}),$(".col").addClass("col-xs-"+12/Math.ceil(f/20)),$(window).on("resize",a.handleBodySize.bind(a))}),this.elem.append(this.button),$(document.body).append(this.body),this.setEvents()},SearchPanelPopupControl.prototype.getValues=function(a){makeDBSearchRequest("/dbsearch?db=Commodity&field=specs."+this.name,a)},SearchPanelPopupControl.prototype.setEvents=function(){this.button.on("click",this.toggle.bind(this)),this.body.on("click",this.hide.bind(this))},SearchPanelPopupControl.prototype.render=function(){this.parent.append(this.elem)},SearchPanelPopupControl.prototype.toggle=function(){this.body.toggleClass("zero-display"),this.handleBodySize()},SearchPanelPopupControl.prototype.hide=function(a){a&&findTarget($(a.target),"col")||this.body.addClass("zero-display")},SearchPanelPopupControl.prototype.handleBodySize=function(){clearTimeout(this.handleBodySizeTimer);var a=this;this.handleBodySizeTimer=setTimeout(function(){var b=$(window);a.body.css({top:a.button.offset().top+a.button.outerHeight(),right:0}),a.body.position().top+a.body.height()>b.height()?a.body.css({position:"absolute"}):a.body.css({position:"fixed"}),b.width()>a.bodyWidth?a.body.css({width:a.bodyWidth+"px"}):a.body.css({width:b.width()+"px"})},100)},SearchPanelPopupControl.prototype.getData=function(){return this._data=this.body.serializeArray(),this._data};